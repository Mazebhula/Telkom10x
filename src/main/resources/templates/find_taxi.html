<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find a Taxi</title>
    <link rel="stylesheet" th:href="@{/css/login.css}" />
</head>
<body>
<div class="find-taxi-container">
    <h2 th:text="${message}">Find a Taxi</h2>
    <p>User: <span th:text="${username}"></span></p>
    <div th:if="${location}">
        <p>Location: <span th:text="${location.latitude + ', ' + location.longitude}"></span>
            <span th:if="${location.city}" th:text="${' (' + location.city + ', ' + location.country + ')'}"></span></p>
        <!-- Add taxi search form or map here -->
    </div>
    <div th:if="${!location}">
        <button onclick="getLocation()">Share My Location</button>
    </div>
    <p><a th:href="@{/dashboard}">Back to Dashboard</a></p>
    <p><a th:href="@{/logout}">Logout</a></p>
</div>
<script>
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    fetch('/location', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `latitude=${position.coords.latitude}&longitude=${position.coords.longitude}`
                    })
                    .then(response => {
                        if (response.redirected) {
                            window.location.href = response.url;
                        }
                    })
                    .catch(error => console.error('Error:', error));
                },
                error => {
                    // Fallback to server-side IP-based geolocation
                    fetch('/location', { method: 'POST' })
                        .then(response => {
                            if (response.redirected) {
                                window.location.href = response.url;
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
            );
        } else {
            alert('Geolocation is not supported by this browser.');
        }
    }
</script>
</body>
</html>